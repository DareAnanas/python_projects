from datetime import datetime
from kivy.app import App
from kivy.uix.relativelayout import RelativeLayout
from kivy.uix.scrollview import ScrollView
from kivy.uix.label import Label
from kivy.graphics import Color, Rectangle
from kivy.properties import ListProperty, ObjectProperty, StringProperty, \
    DictProperty, ColorProperty
from kivy.clock import Clock
from kivy.core.text import LabelBase
from kivy.uix.spinner import SpinnerOption
from kivy.uix.spinner import Spinner
from kivy.core.window import Window

LabelBase.register(
    name="seguiemj",
    fn_regular="/home/danylo/Documents/python_projects/chatbot/seguiemj.ttf"
)

class ColorConverter:
    def hexToRgba(hex_color, alpha=1):
        # Convert a hex color string to an RGBA tuple (0-1 range).
        hex_color = hex_color.lstrip("#")
        r, g, b = int(hex_color[0:2], 16), int(hex_color[2:4], 16), int(hex_color[4:6], 16)
        return [round(r / 255.0, 4), round(g / 255.0, 4), round(b / 255.0, 4), alpha]

class ThemeManager:
    light_theme = {
        'bot_message_color': ColorConverter.hexToRgba('#aad5e3'),
        'user_message_color': ColorConverter.hexToRgba('#8fee8f'),
        'hex_text_color': '000000',
        'bg_color': ColorConverter.hexToRgba('#ffffff'),
        'text_color': ColorConverter.hexToRgba('#000000'),
        'button_color': [0.7, 0.7, 0.7, 1],
        'button_normal': ''
    }
    dark_theme = {
        'bot_message_color': ColorConverter.hexToRgba('#3b4a4f'),
        'user_message_color': ColorConverter.hexToRgba('#2a462a'),
        'hex_text_color': 'ffffff',
        'bg_color': ColorConverter.hexToRgba('#000000'),
        'text_color': ColorConverter.hexToRgba('#ffffff'),
        'button_color': [1, 1, 1, 1],
        'button_normal': 'atlas://data/images/defaulttheme/button'
    }

class EmojiOption(SpinnerOption):
    font_name = StringProperty('seguiemj')
    color = ColorProperty([0, 0, 0, 1])

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.app = App.get_running_app()
        self.color = self.app.theme['text_color']
        self.app.bind(theme=self.updateTheme)

    def updateTheme(self, instance, value):
        self.color = value['text_color']

        

class EmojiSpinner(Spinner):
    option_cls = ObjectProperty(EmojiOption)
    textInput = ObjectProperty(None)

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.bind(on_release=self.on_spinner_open)

    def on_spinner_open(self, spinner):
        dropdown = spinner._dropdown
        for btn in dropdown.container.children:
            btn.bind(on_release=self.on_spinner_select)

    def on_spinner_select(self, button):
        text = button.text
        self.text = text
        if (self.textInput):
            self.textInput.text = self.textInput.text + self.text

class HighlightLabel(Label):
    text_to_display = StringProperty("")
    highlight_range = ListProperty([0, 0])  # (start_idx, end_idx)
    background_color = ListProperty([0, 0, 0, 1])
    highlight_text_color = ListProperty([1, 1, 0, 1])
    highlight_background_color = ListProperty([0, 0, 0, 1])
    colorName = ''
    text_color = StringProperty('')

    def __init__(self, text, colorName, **kwargs):
        super().__init__(**kwargs)
        self.app = App.get_running_app()
        self.text_color = self.app.theme['hex_text_color']
        self.text_to_display = text
        self.colorName = colorName
        self.background_color = self.app.theme[self.colorName]
        self.app.bind(theme=self.updateTheme)

    def updateTheme(self, instance, value):
        self.text_color = value['hex_text_color']
        self.background_color = value[self.colorName]

    def on_text_color(self, *args):
        self.update_markup()

    def on_text_to_display(self, *args):
        self.update_markup()

    def on_highlight_range(self, *args):
        self.update_markup()

    def update_markup(self):
        text = self.text_to_display
        start, end = self.highlight_range
        start = max(0, min(len(text), start))
        end = max(start, min(len(text), end))

        before = text[:start]
        highlight = text[start:end]
        after = text[end:]

        self.markup = True
        self.text = (
            f"[color={self.text_color}]{before}[/color]"
            f"[color=ffff00]{highlight}[/color]"
            f"[color={self.text_color}]{after}[/color]"
        )

class ListItem(HighlightLabel):
    pass

class ListBox(ScrollView):
    layout = ObjectProperty(None)
    items = ListProperty([])

    def on_kv_post(self, base_widget):
        self.layout.bind(minimum_height=self.layout.setter('height'))

    def addMessage(self, text, bg_color):
        label = ListItem(text, bg_color)
        self.layout.add_widget(label)

class ChatBot(RelativeLayout):
    message_id = 0
    messages = [
        "–Ø–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–≤—ñ–π –¥–µ–Ω—å?",
        "–ß–∏ –º–∞—î—à —è–∫—ñ—Å—å –∑–≤–∏—á–∫–∏ –∞–±–æ —Ä–∏—Ç—É–∞–ª–∏, —è–∫—ñ –¥–æ–ø–æ–º–∞–≥–∞—é—Ç—å —Ç–æ–±—ñ –±—É—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–º(-–æ—é)?",
        "–ß–∏ —î —â–æ—Å—å –Ω–æ–≤–µ, —â–æ —Ç–∏ –Ω–µ—â–æ–¥–∞–≤–Ω–æ —Å–ø—Ä–æ–±—É–≤–∞–≤(-–ª–∞) —ñ —Ç–æ–±—ñ —Å–ø–æ–¥–æ–±–∞–ª–æ—Å—è?",
        "–Ø–∫—É –Ω–æ–≤—É –Ω–∞–≤–∏—á–∫—É —Ç–∏ —Ö–æ—Ç—ñ–≤(-–ª–∞) –± –æ–ø–∞–Ω—É–≤–∞—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º?",
        "–©–æ —Ç–µ–±–µ –Ω–∞–π–±—ñ–ª—å—à–µ –º–æ—Ç–∏–≤—É—î —Ä–æ–∑–≤–∏–≤–∞—Ç–∏—Å—è?",
        "–Ø–∫—É –æ—Å—Ç–∞–Ω–Ω—é –∫–Ω–∏–≥—É –∞–±–æ —Å—Ç–∞—Ç—Ç—é —Ç–∏ –ø—Ä–æ—á–∏—Ç–∞–≤(-–ª–∞) –¥–ª—è —Å–∞–º–æ—Ä–æ–∑–≤–∏—Ç–∫—É?",
        "–Ø–∫ —Ç–∏ –∑–∞–∑–≤–∏—á–∞–π –≤—á–∏—à—Å—è ‚Äî —á–µ—Ä–µ–∑ –∫–Ω–∏–≥–∏, –≤—ñ–¥–µ–æ, –ø—Ä–∞–∫—Ç–∏–∫—É —á–∏ —ñ–Ω—à–µ?",
        "–ß–∏ –∫–æ—Ä–∏—Å—Ç—É—î—à—Å—è —Ç–∏ —è–∫–∏–º–∏—Å—å –¥–æ–¥–∞—Ç–∫–∞–º–∏ –∞–±–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –Ω–∞–≤—á–∞–Ω–Ω—è?",
        "–Ø–∫ —Ç–∏ –±–æ—Ä–µ—à—Å—è –∑ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü—ñ—î—é?",
        "–©–æ –¥–ª—è —Ç–µ–±–µ –æ–∑–Ω–∞—á–∞—î '–µ—Ñ–µ–∫—Ç–∏–≤–Ω–µ –Ω–∞–≤—á–∞–Ω–Ω—è'?",
        "–Ø–∫–∏–π –±—É–≤ —Ç–≤—ñ–π –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à–∏–π –¥–æ—Å–≤—ñ–¥ –Ω–∞–≤—á–∞–Ω–Ω—è, —ñ —è–∫ —Ç–∏ –π–æ–≥–æ –ø–æ–¥–æ–ª–∞–≤(-–ª–∞)?",
        "–ß–∏ –º–∞—î—à –º–µ–Ω—Ç–æ—Ä—ñ–≤ –∞–±–æ –ª—é–¥–µ–π, —è–∫—ñ —Ç–µ–±–µ –Ω–∞–¥–∏—Ö–∞—é—Ç—å —É —Ä–æ–∑–≤–∏—Ç–∫—É?",
        "–Ø–∫ —Ç–∏ –æ—Ü—ñ–Ω—é—î—à —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å —É —Å–∞–º–æ—Ä–æ–∑–≤–∏—Ç–∫—É?",
        "–ß–∏ –≤–µ–¥–µ—à —Ç–∏ —â–æ–¥–µ–Ω–Ω–∏–∫ –∞–±–æ –∑–∞–ø–∏—Å–∏ —Å–≤–æ—ó—Ö –¥—É–º–æ–∫ —ñ —Ü—ñ–ª–µ–π?",
        "–Ø–∫—ñ –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å–∏ –∞–±–æ —Ä–µ—Å—É—Ä—Å–∏ —Ç–∏ –± –ø–æ—Ä–∞–¥–∏–≤(-–ª–∞) —ñ–Ω—à–∏–º?",
        "–ß–∏ –ø–ª–∞–Ω—É—î—à —Å–≤—ñ–π —á–∞—Å –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è? –Ø–∫—â–æ —Ç–∞–∫, —Ç–æ —è–∫?",
        "–Ø–∫ –∑–º—ñ–Ω–∏–ª–∏—Å—è —Ç–≤–æ—ó –ø—ñ–¥—Ö–æ–¥–∏ –¥–æ —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—ñ–∫?",
        "–ß–∏ –º–∞—î—à –¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤—É –º–µ—Ç—É –≤ –Ω–∞–≤—á–∞–Ω–Ω—ñ? –Ø–∫—É?",
        "–Ø–∫ —Ç–∏ –≤—ñ–¥–Ω–æ–≤–ª—é—î—à —Å–∏–ª–∏ –ø—ñ—Å–ª—è —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–≥–æ –Ω–∞–≤—á–∞–Ω–Ω—è?",
        "–ß–∏ –±—É–≤ —É —Ç–µ–±–µ –º–æ–º–µ–Ω—Ç, –∫–æ–ª–∏ —Ç–∏ —Ö–æ—Ç—ñ–≤(-–ª–∞) –∑–¥–∞—Ç–∏—Å—è, –∞–ª–µ –Ω–µ –∑—Ä–æ–±–∏–≤(-–ª–∞) —Ü—å–æ–≥–æ? –©–æ –¥–æ–ø–æ–º–æ–≥–ª–æ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?",
    ]

    answers = [
        '–í—Å–µ —á—É–¥–æ–≤–æ!', 
        '–ó–∞–π–Ω—è—Ç–∏—Å—è –π–æ–≥–æ—é.', 
        '–ù—ñ, –Ω–µ–º–∞—î. –î—É–º–∞—é, —Ü–µ —Ç—Ä–µ–±–∞ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏.',
        '–•–æ—á—É –ø–æ–≥—Ä–∞—Ç–∏ –î–Ω–î –Ω–∞ –ø—Ä–∏—Ä–æ–¥—ñ!',
        '–ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –¥–æ–ø–æ–º–æ–≥—Ç–∏ —ñ–Ω—à–∏–º –ª—é–¥—è–º.',
        '"–ß–æ–º—É –º–∏ —É—Å–∫–ª–∞–¥–Ω—é—î–º–æ –∂–∏—Ç—Ç—è?"',
        '–Ø –∑–∞–∑–≤–∏—á–∞–π –≤—á—É—Å—è —á–µ—Ä–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫—É.',
        '–ù—ñ, –Ω–µ –∫–æ—Ä–∏—Å—Ç—É—é—Å—å.',
        '–°—Ç–∞–≤–ª—é —Å–æ–±—ñ –¥–µ–¥–ª–∞–π–Ω–∏.',
        '–¶–µ –∫–æ–ª–∏ –º–µ–Ω—ñ –ø–æ–¥–æ–±–∞—î—Ç—å—Å—è —Ç–µ, —â–æ —è –≤—á—É.',
        '–ú—ñ–π –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à–∏–π –¥–æ—Å–≤—ñ–¥ –Ω–∞–≤—á–∞–Ω–Ω—è –±—É–≤ –∫–æ–ª–∏ —è –≤—á–∏–≤ —Å—Ö–µ–º–æ—Ç–µ—Ö–Ω—ñ–∫—É. –Ü —è –ø–æ–¥–æ–ª–∞–≤ –π–æ–≥–æ —Ç–∏–º, —â–æ –æ—Ç—Ä–∏–º–∞–≤ –ø—ñ–¥—Ç—Ä–∏–º–∫—É –≤—ñ–¥ –¥—Ä—É–∑—ñ–≤üòÄ',
        '–ú–µ–Ω—Ç–æ—Ä—ñ–≤ –Ω–µ –º–∞—é, –∞–ª–µ –º–∞—é –¥—Ä—É–∑—ñ–≤ —ñ –∑–Ω–∞–π–æ–º–∏—Ö, —è–∫—ñ –Ω–∞–¥–∏—Ö–∞—é—Ç—å —É —Ä–æ–∑–≤–∏—Ç–∫—É.',
        '–Ø –∑–∞–±–∞–≥–∞—Ç–æ —á–∞—Å—É –≤–∏—Ç—Ä–∞—á–∞—é –Ω–∞ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è —Ç–∞–º –¥–µ –Ω–µ —Ç—Ä–µ–±–∞, –∞ —Ç–∞–º –¥–µ —Ç—Ä–µ–±–∞, —Ç–æ –∑–∞–º–∞–ª–æüò¢',
        '–í–µ–¥—É. –¢–∞–º —è –∑–∞–ø–∏—Å—É—é —Å–≤–æ—ó —ñ–¥–µ—ó —Ç–∞ —Ü—ñ–ª—ñ.',
        '–ö—É—Ä—Å–∏ Prometheus.',
        '–ù—ñ, –Ω–µ –ø–ª–∞–Ω—É—é‚òπ. –ú–æ–∂–ª–∏–≤–æ —Ü–µ –ø–æ–º–∏–ª–∫–∞.Ô∏è',
        '–ö—Ä–∞—â–µ –∑—Ä–æ–±–∏—Ç–∏ –≥—ñ—Ä—à–µ, –Ω—ñ–∂ –≤–∑–∞–≥–∞–ª—ñ –Ω–µ –∑—Ä–æ–±–∏—Ç–∏.',
        "–ù—ñ, –º–µ—Ç–∏ –Ω–∞ 5 —Ä–æ–∫—ñ–≤ –Ω–µ–º–∞—î —á–µ—Ä–µ–∑ –Ω–∞–≤—á–∞–Ω–Ω—è –≤ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ. –ê–ª–µ –¥—É–º–∞—é —Ü–µ —â–æ—Å—å –ø–æ–≤'—è–∑–∞–Ω–µ –∑ —Ä–æ–∑—Ä–æ–±–∫–æ—é –¥–æ–¥–∞—Ç–∫—ñ–≤ –Ω–∞ Android.",
        '–ü—Ä–æ–±—É—é –±–∞–≥–∞—Ç–æ —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É. –ü–æ–ª–µ–∂–∞—Ç–∏ –Ω–∞ –ª—ñ–∂–∫—É, –ø–æ–±—ñ–≥–∞—Ç–∏ —É –ª—ñ—Å—ñ, –ø–æ–≥—Ä–∞—Ç–∏ —É –≤—ñ–¥–µ–æ—ñ–≥—Ä–∏, –ø–æ–≥—Ä–∞—Ç–∏ —É –Ω–∞—Å—Ç—ñ–ª—å–Ω—ñ —ñ–≥—Ä–∏ –∑ –¥—Ä—É–∑—è–º–∏ —Ç–∞ –ø—ñ—Ç–∏ –Ω–∞ –ø—Ä–æ–≥—É–ª—è–Ω–∫—É.'
        '–ú–µ–Ω—ñ –¥–æ–ø–æ–º–æ–≥–ª–æ —Ç–µ, –∑–∞ –¥–ª—è –∫–æ–≥–æ —è —Ü–µ —Ä–æ–±–ª—é.'
    ]

    items = [
        'Bebra',
        'BebraBebra',
        'BebraBebraBebra',
        'BebraBebraBebraBebra',
        'BebraBebraBebraBebraBebra',
        'BebraBebraBebraBebraBebra\nBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebraBebra'
    ]

    listBox = ObjectProperty(None)
    messageInput = ObjectProperty(None)
    findInput = ObjectProperty(None)
    matchCaseCheckBox = ObjectProperty(None)

    def addTimeStamp(self, text):
        timestamp = datetime.now().strftime("%H:%M:%S")
        return timestamp + ' ' + text

    def addUserMark(self, username, text):
        return username + ' ' + text

    def on_kv_post(self, base_widget):
        self.app = App.get_running_app()
        self.getReply()

    def getReply(self):
        message = self.messages[self.message_id]
        message = self.addUserMark('Bot:', message)
        message = self.addTimeStamp(message)
        self.listBox.addMessage(message, 'bot_message_color')

    def sendMessage(self):
        message = self.messageInput.text.strip()
        if (message == ''):
            return
        self.messageInput.text = ''
        message = self.addUserMark('You:', message)
        message = self.addTimeStamp(message)
        self.listBox.addMessage(message, 'user_message_color')
        if (self.message_id >= len(self.messages) - 1):
            return
        self.message_id += 1
        Clock.schedule_once(lambda dt: self.getReply(), 0.5)

    def clearHighLights(self):
        for label in self.listBox.layout.children:
            label.highlight_range = [0, 0]

    def findAll(self):
        if (self.matchCaseCheckBox.active):
            text = self.findInput.text.strip()
            for label in self.listBox.layout.children:
                index = label.text_to_display.find(text)
                if (index == -1):
                    label.highlight_range = [0, 0]
                    continue
                label.highlight_range = [index, index + len(text)]
        else:
            text = self.findInput.text.strip().lower()
            for label in self.listBox.layout.children:
                index = label.text_to_display.lower().find(text)
                if (index == -1):
                    label.highlight_range = [0, 0]
                    continue
                label.highlight_range = [index, index + len(text)]

class ChatBotApp(App):
    theme = DictProperty(ThemeManager.dark_theme)

    def changeTheme(self):
        if (self.theme == ThemeManager.light_theme):
            self.theme = ThemeManager.dark_theme
        elif (self.theme == ThemeManager.dark_theme):
            self.theme = ThemeManager.light_theme

    def build(self):
        Window.bind(on_key_down=self._on_key_down)
        self.chatbot = ChatBot()
        return self.chatbot

    def _on_key_down(self, window, key, scancode, codepoint, modifiers):
        if key == 13:
            self.chatbot.sendMessage()
        if key == 27:
            self.chatbot.clearHighLights()
            return True
        return False

if __name__ == '__main__':
    ChatBotApp().run()